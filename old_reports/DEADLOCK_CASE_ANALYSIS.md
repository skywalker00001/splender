# 🔍 中等AI 2人局死锁案例深度分析

## 案例：game_20251016_090301_中等_2P_test2

### 📊 核心数据

| 指标 | 数值 |
|------|------|
| 总回合数 | 300（超时） |
| 成功购卡次数 | **0次** |
| 最终分数 | 赤红0分, 青绿0分 |
| 最终持球 | 各9个（黑2, 粉2, 黄2, 蓝2, 红1） |
| 最终球池 | 2个彩球 + 5个大师球 |
| 预购次数 | 0次 |

### 🕐 时间线分析

#### 第1-10回合：疯狂拿球阶段
```
回合1-2:  两个AI各拿3个球
回合3-4:  继续拿球
回合5-10: 持续拿球
结果：球池从17个彩球 → 2个彩球
      两个AI各持球9个
```

#### 第11-300回合：死循环阶段  
```
状态：持球9个（黑2, 粉2, 黄2, 蓝2, 红1）
      预购区空
      球池只剩2个彩球

动作：每回合尝试购买"蚊香蝌蚪"
结果：失败
原因：成本不匹配/资源不足

循环290次后超时！
```

### 🚨 根本原因分析

#### 问题1：拿球策略失败
**表现**：
- 中等AI疯狂拿球但不考虑场上卡牌成本
- 拿到的球（黑2, 粉2, 黄2, 蓝2, 红1）买不起任何1级卡

**推测**：
- 1级卡"蚊香蝌蚪"可能需要：蓝3个 或类似成本
- AI持有的球分散（每种2个），无法凑齐任何一张卡

#### 问题2：从不预购
**表现**：
- 整个游戏预购次数=0
- 错过了获取大师球的机会
- 大师球可以代替任何颜色

**原因**：
- 中等AI的预购条件可能是"持球>=7"
- 但持球到9个后，AI认为可以买卡了
- 尝试买卡失败后，没有fallback到预购

#### 问题3：球池枯竭破局策略未触发
**破局阈值**：`colored_balls_in_pool <= 6`

**实际球池**：2个彩球

**为什么没触发**：
- 球池枯竭策略在第135行
- 但如果在此之前AI已经决定"尝试买卡"
- 可能优先级不够高

### 💡 问题定位

**核心矛盾**：中等AI在持球9个时的逻辑
```python
# 当前逻辑（推测）
if buyable_cards:
    return buy_card(buyable_cards[0])  # 但实际买不起！
```

**_get_buyable_cards** 可能错误地认为"蚊香蝌蚪"可买：
- 可能是`_can_afford`使用了永久折扣
- 但AI还没有任何卡牌（owned=0），没有永久折扣
- 或者成本计算有bug

### 🔧 建议修复方案

#### 方案1：修复中等AI的拿球策略
```python
def _medium_strategy(...):
    # 在拿球前检查持球数
    if player.get_total_balls() >= 8:
        # 不要继续拿球，尝试买卡或预购
        buyable = self._get_buyable_cards(game, player)
        if not buyable:
            # 买不起，应该预购获取大师球
            return reserve_action
```

#### 方案2：增强球池枯竭检测优先级
```python
def _medium_strategy(...):
    # 第一优先级：球池枯竭检测（移到最前面）
    colored_balls = sum([...])
    if colored_balls <= 6:
        # 启动破局策略
```

#### 方案3：修复buyable_cards判断
确保`_get_buyable_cards`返回的都是**真正**能买的卡：
```python
def _get_buyable_cards(...):
    buyable = []
    for card in all_cards:
        if self._can_really_afford(player, card):  # 使用严格检查
            buyable.append(card)
    return buyable
```

### 🎯 根本解决方案

**核心问题**：中等AI的球池枯竭策略位置太靠后

**当前顺序**：
1. 优先级1: 购买卡牌 ← **错误地认为能买**
2. 优先级2-4: 其他策略
3. （球池枯竭检测在此）

**应该调整为**：
```python
def _medium_strategy(...):
    # === 最高优先级：球池枯竭检测 ===
    colored_balls_in_pool = sum([...])
    if colored_balls_in_pool <= 6:
        # 破局策略...
    
    # === 优先级1: 购买卡牌 ===
    buyable_cards = self._get_buyable_cards(...)
    ...
```

---

**分析时间**: 2025-10-16  
**案例严重程度**: 🔴 极严重（300回合0购卡）  
**影响范围**: 中等AI 2人局（20%成功率）

