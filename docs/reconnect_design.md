# 对局重连与退出机制设计

## 一、概述

游戏中存在两种"退出"场景：
1. **主动退出** - 玩家点击"退出游戏"按钮
2. **无意退出** - 玩家关闭页面/浏览器回退/网络断开

这两种场景需要不同的处理逻辑。

---

## 二、主动退出

### 触发条件
- 玩家在游戏进行中点击"退出游戏"按钮并确认

### 处理流程

```
玩家点击"退出游戏"
    ↓
弹出确认对话框："确定要退出游戏吗？退出后将无法重新加入本局游戏。"
    ↓
玩家确认
    ↓
后端检查真人玩家数量（不包括机器人和已退出的玩家）
    ↓
┌─────────────────────────────────────────────────────────┐
│ 如果 剩余真人数量 >= 1（还有真人玩家）：                │
│   1. 标记该玩家为"已退出"状态（has_left = true）        │
│   2. 清除玩家与房间的映射关系                           │
│   3. 玩家可以创建/加入其他房间                          │
│   4. 该玩家的回合自动跳过                               │
│   5. 游戏继续进行                                       │
│   6. 该玩家不能重连到此房间                             │
├─────────────────────────────────────────────────────────┤
│ 如果 剩余真人数量 == 0（只剩机器人或无人）：            │
│   1. 游戏正式结束，按当前分数计算最终排名               │
│   2. 保存完整的对局历史（包含排名，标记结束原因）       │
│   3. 销毁房间                                           │
│   4. 所有相关玩家的映射关系清除                         │
│   注：此情况视为游戏正常结束，记录到对局历史中          │
└─────────────────────────────────────────────────────────┘
```

### 数据结构变化

需要为玩家添加 `has_left` 标志：

```python
# Player 类
class Player:
    def __init__(self, name):
        # ... 现有属性 ...
        self.has_left = False  # 是否已主动退出游戏
```

### 回合跳过逻辑

当轮到已退出玩家时：
```python
def end_turn(self):
    # 切换到下一个玩家
    self.current_player_index = (self.current_player_index + 1) % len(self.players)
    
    # 跳过已退出的玩家
    while self.players[self.current_player_index].has_left:
        self.current_player_index = (self.current_player_index + 1) % len(self.players)
        # 防止无限循环（所有真人都退出了）
        if all(p.has_left or self._is_ai(p.name) for p in self.players):
            # 所有真人都退出了，但还有机器人
            # 此时应该结束游戏或让机器人自动完成
            break
```

---

## 三、无意退出（重连机制）

### 触发条件
- 玩家关闭浏览器标签页
- 玩家刷新页面
- 玩家按浏览器后退按钮
- 网络断开

### 处理流程

```
玩家无意退出（页面关闭等）
    ↓
玩家数据保持不变（不标记 has_left）
房间与玩家的映射关系保持
    ↓
玩家重新打开页面/登录
    ↓
前端检查 localStorage 中的 gameSession
    ↓
┌─────────────────────────────────────────────────────────┐
│ 如果存在有效的 gameSession：                            │
│   1. 调用 API 检查房间是否存在                          │
│   2. 检查玩家是否还在房间中                             │
│   3. 检查玩家是否已被标记为 has_left                    │
├─────────────────────────────────────────────────────────┤
│ 如果房间存在 且 玩家在房间中 且 未被标记为已退出：      │
│   → 强制重连到原对局（不提供"开始新游戏"选项）          │
│   → 如果想开始新游戏，必须先主动退出原对局              │
├─────────────────────────────────────────────────────────┤
│ 如果房间不存在 或 玩家不在房间中 或 已被标记为退出：    │
│   → 清除 gameSession，允许开始新游戏                    │
└─────────────────────────────────────────────────────────┘
```

### 重连时的状态恢复

重连成功后：
1. 恢复游戏界面
2. 同步最新游戏状态
3. 如果轮到该玩家，恢复操作权

---

## 四、API 变更

### 1. 修改 `/api/rooms/<room_id>/leave` 接口

新增参数：
- `voluntary`: boolean - 是否主动退出（默认 true）

返回值新增：
- `room_destroyed`: boolean - 房间是否被销毁
- `remaining_human_players`: int - 剩余真人玩家数量

### 2. 修改 `/api/rooms/<room_id>/state` 接口

返回值的 `player_states` 中新增：
- `has_left`: boolean - 该玩家是否已主动退出

### 3. 新增玩家状态检查逻辑

在获取游戏状态时，标记已退出玩家：
```json
{
  "player_states": {
    "玩家1": {
      "balls": {...},
      "victory_points": 10,
      "has_left": false
    },
    "玩家2": {
      "balls": {...},
      "victory_points": 8,
      "has_left": true  // 已退出
    }
  }
}
```

---

## 五、前端变更

### 1. 退出确认对话框

主动退出时显示更明确的警告：
```
⚠️ 确定要退出游戏吗？

退出后：
• 你将无法重新加入本局游戏
• 你的回合将被自动跳过
• 你可以开始新的游戏

[确定退出] [取消]
```

### 2. 游戏界面显示

对于已退出的玩家，显示特殊标识：
- 玩家名旁边显示"(已退出)"标签
- 玩家面板使用灰色/半透明样式

### 3. 重连逻辑修改

**无意退出后的重连弹窗**（强制重连，无选择）：
```
🎮 检测到未完成的游戏

房间号：xxxxx
玩家名：xxxxx  
状态：进行中

你有一局未完成的游戏，请继续完成。
如需退出，请在游戏内点击"退出游戏"按钮。

[继续游戏]
```

**重连检查逻辑**：
```javascript
// 检查是否可以重连
if (playerState.has_left) {
    // 玩家已主动退出，不允许重连
    clearGameSession();
    showToast('你已退出该游戏，无法重连', 'info');
    return;
}

// 未主动退出，强制重连
reconnectToGame(session, gameState);
```

**注意**：无意退出的玩家不能选择"开始新游戏"，必须先重连原对局，
如果想退出，需要在游戏内点击"退出游戏"按钮主动退出。

---

## 六、边界情况处理

### 1. 所有真人都退出

当最后一个真人玩家主动退出时：
- 游戏正式结束，按当前分数计算排名
- 保存完整的对局历史到 `game_history/` 目录
- 历史记录中标注结束原因："所有真人玩家退出"
- 销毁房间

注：`game_history/` 目录已在 `.gitignore` 中忽略，不会上传到 git

### 2. 当前回合玩家退出

如果正在行动的玩家主动退出：
1. 立即结束当前回合（不执行任何操作）
2. 跳到下一个未退出的玩家

### 3. 游戏结束时有退出玩家

- 退出的玩家仍计入排名
- 排名基于退出时的分数（不再增加）

### 4. 房主退出

- 游戏进行中：房主退出不解散房间，游戏继续
- 等待状态：房主退出解散房间（现有逻辑）

---

## 七、实现步骤

1. **后端修改**
   - [x] Player 类添加 `has_left` 属性 (`splendor_pokemon.py` 第67行)
   - [x] 修改 `leave_room` API，处理主动退出逻辑 (`backend/app.py` 第809-890行)
   - [x] 修改 `end_turn` 逻辑，跳过已退出玩家 (`splendor_pokemon.py` 第713-724行)
   - [x] 修改 `get_game_state`，返回 `has_left` 状态 (`backend/app.py` 第328行)
   - [x] 添加真人玩家数量计算逻辑 (`backend/app.py` 第824-828行)

2. **前端修改**
   - [x] 修改退出确认对话框 (`web/static/js/main.js` 第1105-1115行)
   - [x] 修改重连检查逻辑 (`web/static/js/main.js` 第261-310行)
   - [x] 添加已退出玩家的UI显示 (`web/static/js/game.js` 第883-893行, `web/static/css/style.css`)
   - [x] 统一重连弹窗样式（粉色渐变 + pulse动画）(`web/static/js/main.js` 第309-402行)
   - [x] localStorage 存储游戏会话（支持关闭标签页后重连）(`web/static/js/main.js` 第24-63行)

3. **测试场景**
   - [ ] 单人退出，游戏继续
   - [ ] 最后真人退出，房间销毁
   - [ ] 无意退出后重连
   - [ ] 主动退出后无法重连
   - [ ] 当前回合玩家退出

---

## 八、实现详情

### 实现时间
2026-02-13

### 关键代码位置

| 功能 | 文件 | 位置 |
|------|------|------|
| Player.has_left 属性 | `splendor_pokemon.py` | 第67行 |
| 跳过已退出玩家 | `splendor_pokemon.py` | 第713-724行 |
| leave_room 主动退出 | `backend/app.py` | 第809-890行 |
| 返回 has_left 状态 | `backend/app.py` | 第328行 |
| 真人玩家计数 | `backend/app.py` | 第824-828行 |
| 退出确认对话框 | `web/static/js/main.js` | 第1105-1115行 |
| 重连弹窗 | `web/static/js/main.js` | 第309-402行 |
| 重连检查 | `web/static/js/main.js` | 第261-310行 |
| 会话存储 | `web/static/js/main.js` | 第24-63行 |
| 已退出玩家UI | `web/static/js/game.js` | 第883-893行 |
| 已退出玩家样式 | `web/static/css/style.css` | 第807-829行 |

### 核心逻辑说明

#### 1. 主动退出流程
```
用户点击"退出游戏" 
  → 弹出确认对话框（警告无法重连）
  → 调用 leave_room API
  → 后端标记 player.has_left = True
  → 计算剩余真人数量
  → 如果 >= 1：游戏继续，该玩家回合被跳过
  → 如果 == 0：游戏结束，保存历史，销毁房间
```

#### 2. 无意退出重连流程
```
用户刷新页面/关闭后重开
  → initApp 检查 localStorage 中的 gameSession
  → 调用 checkUnfinishedGame()
  → 验证房间存在 && 玩家在房间 && !has_left
  → 显示强制重连弹窗（无"开始新游戏"选项）
  → 用户点击"重新加入游戏"
  → 恢复游戏界面
```

#### 3. 回合跳过逻辑
```python
# splendor_pokemon.py end_turn()
while self.players[self.current_player_index].has_left:
    self.current_player_index = (self.current_player_index + 1) % len(self.players)
    if skip_count >= len(self.players):
        # 所有玩家都退出了，游戏结束
        break
```

### 注意事项

1. **gameSession 使用 localStorage**（非 sessionStorage），确保关闭标签页后数据不丢失
2. **重连弹窗强制用户处理**，游戏进行中只有"重新加入"选项，无法跳过
3. **剩余真人 == 0 时才销毁房间**，1个真人 + 机器人仍可继续游戏
4. **已退出玩家显示灰色半透明样式 + "已退出"标签**
