# 🎮 璀璨宝石宝可梦 - 游戏逻辑流程图

## 📊 游戏总体流程

```
游戏开始（4人，默认18分胜利）
    ↓
┌─→ 回合开始（玩家1 → 玩家2 → 玩家3 → 玩家4）
│   │
│   ├─→ I. 选择并执行动作（三选一，必选）
│   │   ├─→ 1. 拿球
│   │   ├─→ 2. 买卡
│   │   └─→ 3. 预购
│   │
│   ├─→ II. 动作完成 → 自动进入进化阶段
│   │   ├─→ 检查是否有可进化卡牌
│   │   ├─→ 如果有：玩家选择进化或跳过（最多进化1张）
│   │   └─→ 如果没有：自动跳过
│   │
│   └─→ III. 进化阶段结束 → 检查分数
│       ├─→ 如果 ≥18分 → 标记最后一轮（is_last_turn = True）
│       │   └─→ 提示所有玩家"游戏进入最后一轮！"
│       │
│       ├─→ 如果是最后一轮 && 当前是玩家4 → 游戏结束，统计排名
│       │
│       └─→ 否则 → 下一个玩家回合
│
└─── 循环直到游戏结束
```

---

## 📋 详细动作流程

### 1️⃣ 拿球动作（Action: Take Balls）

```
选择拿球
    ↓
┌─→ 玩家点击球进行选择
│   
├─→ 情况1：未选择任何球（拿取栏显示"无"）
│   └─→ 点击任意颜色 → 选中1个该颜色球
│
├─→ 情况2：已选择1个球
│   ├─→ 点击同一颜色：
│   │   ├─→ 检查：该颜色球池 ≥ 4个？
│   │   │   ├─→ ✅ 是：选中第2个该颜色球（共2个同色）
│   │   │   └─→ ❌ 否：弹出提示"拿取2个相同颜色的球需要该颜色池中≥4个"
│   │   │
│   │   └─→ 点击不同颜色 → 选中1个新颜色球（共2个不同色）
│   │
│   └─→ 点击不同颜色 → 选中1个新颜色球（共2个不同色）
│
├─→ 情况3：已选择2个同色球
│   └─→ 点击任一颜色的球（包括同色或其他颜色）：
│       └─→ 弹出确认框："最多拿同一个颜色的2个球"
│           └─→ 点击"确定"：清空拿取栏（变为"无"），"拿取宝石"按钮置灰
│
├─→ 情况4：已选择2个不同色球
│   ├─→ 点击已选颜色：
│   │   └─→ 弹出提示："已选择该颜色，不能重复选择"
│   │
│   └─→ 点击新颜色（第3个不同色）：
│       └─→ 选中1个新颜色球（共3个不同色）
│
└─→ 情况5：已选择3个不同色球（拿满）
    └─→ 点击任意颜色：
        └─→ 弹出确认框："最多拿三个不同颜色的各1个球"
            └─→ 点击"确定"：清空拿取栏（变为"无"），"拿取宝石"按钮置灰

【点击"拿取宝石"按钮】
    │
    ├─→ 按钮状态检查（动态更新）：
    │   ├─→ 不是当前玩家回合：按钮灰色
    │   ├─→ 未选择任何球：按钮灰色
    │   │
    │   └─→ 检查选择是否符合规则（remained_color = 场上>0个球的颜色数）：
    │       │
    │       ├─→ remained_color ≥ 3（球充足）：
    │       │   ├─→ ✅ 选了2个同色球 且 该颜色池≥4：按钮亮起
    │       │   ├─→ ✅ 选了3个不同色球：按钮亮起
    │       │   └─→ ❌ 其他情况：按钮灰色
    │       │
    │       └─→ remained_color < 3（球不充足）：
    │           ├─→ ✅ 拿取栏数目 == remained_color（拿了所有可用颜色各1个）：按钮亮起
    │           └─→ ❌ 其他情况：按钮灰色
    │
    └─→ 点击"拿取宝石"按钮（亮起时）→ 发送请求到后端
        ↓
    【球数检查】
        ↓
    持球总数（包括大师球） > 10？
        │
        ├─→ ❌ 否（≤10）：动作完成 → 自动进入进化检查
        │
        └─→ ✅ 是（>10）：进入放回流程
            ├─→ 计算需放回数量 = 当前总数 - 10
            ├─→ 显示提示："当前球为X枚，所持上限为10枚，需放回Y枚球"
            │
            ├─→ 玩家操作：点击自己的球堆选择要放回的球
            │   └─→ 每点击一次 = 选择放回该颜色1枚球
            │
            ├─→ 已选球数 < 需放回数：
            │   └─→ "放回"按钮保持灰色（不可点击）
            │
            ├─→ 已选球数 = 需放回数：
            │   ├─→ "放回"按钮亮起（可点击）
            │   └─→ 禁止继续选择球
            │
            ├─→ 点击"清除"按钮：
            │   └─→ 重置选择，从0开始重新选择
            │
            └─→ 点击"放回"按钮（亮起时）：
                └─→ 执行放回 → 动作完成 → 自动进入进化检查
```

**规则要点：**
- **球充足时（场上≥3种颜色可用）：**
  - 同色2球：必须该颜色池 ≥4个
  - 不同色：必须拿3个不同颜色各1个
- **球不充足时（场上<3种颜色可用）：**
  - 必须拿场上所有可用颜色各1个（最多2个）
- **按钮亮起条件：**
  - 球充足：拿了2个同色 或 3个不同色
  - 球不充足：拿了所有可用颜色各1个
- 选满后再点击：弹出确认框，用户确认后清空拿取栏，按钮置灰
- 持球上限：10个（含大师球）
- 放回：可以放回任意颜色（包括大师球）

---

### 2️⃣ 买卡动作（Action: Buy Card）

```
点击一张卡牌
    ↓
【预计算是否可购买】
    │
    ├─→ Step 1: 计算卡牌实际消耗
    │   │
    │   └─→ 对每种颜色：
    │       实际消耗[颜色] = 卡牌成本[颜色] - 玩家抵扣[颜色]
    │       （注意：实际消耗不能 < 0）
    │
    ├─→ Step 2: 计算每种颜色的差值
    │   │
    │   └─→ 对每种颜色：
    │       差值[颜色] = 实际消耗[颜色] - 手中球数[颜色]
    │       如果 差值[颜色] < 0，则 差值[颜色] = 0
    │       （负数表示该颜色绰绰有余，不需要大师球补充）
    │
    ├─→ Step 3: 检查大师球是否足够
    │   │
    │   ├─→ 总差值 = Σ差值[所有颜色]
    │   └─→ 总差值 ≤ 大师球数量？
    │
    └─→ 显示结果：
        ├─→ ✅ 可购买：购买按钮亮起
        └─→ ❌ 不可购买：购买按钮灰色

点击"购买"按钮（亮起状态）
    ↓
弹出支付界面（三排 + 购买按钮）
    │
    ├─→ 第一排：显示实际净消耗
    │   └─→ 各颜色实际消耗（扣除抵扣后，≥0）
    │
    ├─→ 第二排：显示所持球
    │   └─→ 玩家当前各颜色球数量（包括大师球）
    │
    ├─→ 第三排：可调整的支付方案
    │   ├─→ 每种颜色有 +/- 按钮
    │   ├─→ 大师球可充当任意颜色（万能球）
    │   └─→ 玩家调整支付组合
    │
    └─→ 检查支付方案是否合法：
        ├─→ 每种颜色支付 ≥ 实际消耗？
        ├─→ 总支付 ≤ 手中拥有？
        │
        └─→ ✅ 合法：购买按钮亮起
            └─→ 点击购买 → 扣除球 → 获得卡牌 → 更新分数 → 动作完成 → 自动进入进化检查
```

**购买逻辑示例：**

```
例：玩家购买一张卡牌
卡牌成本：红3 蓝2 黄1
玩家抵扣：红1 蓝0 黄0
手中球：红2 蓝1 黄0 大师球3

计算过程：
1. 实际消耗：红2(3-1) 蓝2(2-0) 黄1(1-0)
2. 差值：红0(2-2) 蓝1(2-1) 黄1(1-0)
3. 总差值：0+1+1 = 2
4. 大师球：3个 ≥ 2 → 可以购买！

支付方案（示例）：
- 红球：2个
- 蓝球：1个
- 黄球：0个
- 大师球：2个（替代蓝1+黄1）
```

---

### 3️⃣ 预购动作（Action: Reserve Card）

```
点击一张卡牌
    ↓
【检查预购条件】
    │
    ├─→ 卡牌是Lv4或Lv5（稀有/传说）？
    │   └─→ ✅ 是：预购按钮灰色（不可点击）
    │       └─→ 提示："稀有/传说卡牌不可预购"
    │
    ├─→ 预购区卡牌数量 ≥ 3张？
    │   │
    │   ├─→ ✅ 是：预购按钮灰色（不可点击）
    │   │   └─→ 提示："预购区已满（3/3）"
    │   │
    │   └─→ ❌ 否（< 3张）：预购按钮亮起
    │       ↓
    │   点击"预购"按钮
    │       ↓
    │   检查大师球数量
    │       │
    │       ├─→ 大师球 = 0：
    │       │   └─→ 弹出确认框：
    │       │       "当前大师球数量为0，是否仅预购？"
    │       │       ├─→ 确认：执行预购
    │       │       └─→ 取消：返回选择
    │       │
    │       └─→ 大师球 > 0：
    │           └─→ 直接执行预购
    │               ↓
    │           【执行预购】
    │               ├─→ 玩家大师球 +1
    │               ├─→ 卡牌加入预购区
    │               ├─→ 如果是场上卡：从场上移除并补充新卡
    │               └─→ 动作完成 → 自动进入进化检查
```

**预购要点：**
- 预购区上限：3张
- 预购奖励：+1大师球
- 可预购对象：
  - ✅ 场上可见卡牌（Lv1/2/3）
  - ✅ Lv1/2/3的牌堆顶盲预购（不知道是什么卡）
- 预购限制：
  - ❌ Lv4/5稀有传说卡**不能**被预购

---

## 🔄 进化阶段详细流程

```
动作结束 → 自动进入进化阶段
    ↓
【检查所有拥有卡牌】
遍历玩家展示区的每张卡牌：
    │
    ├─→ 检查1：是1级或2级卡？
    │   └─→ ❌ 否（3级或更高）：跳过此卡，检查下一张
    │
    ├─→ 检查2：查找进化目标
    │   │
    │   ├─→ 1级卡 → 在以下位置查找2级进化目标：
    │   │   ├─ 场上2级卡池
    │   │   └─ 自己的预购区
    │   │
    │   └─→ 2级卡 → 在以下位置查找3级进化目标：
    │       ├─ 场上3级卡池
    │       └─ 自己的预购区
    │
    ├─→ 检查3：找到进化目标了吗？
    │   └─→ ❌ 否：跳过此卡，检查下一张
    │
    └─→ 检查4：检查进化所需抵扣球
        │
        ├─→ 从卡牌上读取进化要求（卡牌已标注）
        │   └─→ 例如：蚊香蝌蚪卡牌上标注"→蚊香君,蓝,2"
        │       表示需要：蓝色抵扣球 ≥ 2个
        │
        ├─→ 玩家抵扣区有足够的指定颜色球吗？
        │   └─→ ✅ 是：标记为"可进化"
        │
        └─→ ⚠️ 重要：必须用抵扣球进化
            └─→ 不能消耗手中的精灵球

【进化操作界面】
有至少一张可进化卡牌？
    │
    ├─→ ❌ 否：自动跳过进化阶段 → 进入分数检查
    │
    └─→ ✅ 是：显示进化界面
        │
        ├─→ 界面显示：
        │   ├─ 按钮1："进化"（初始灰色）
        │   └─ 按钮2："跳过进化"
        │
        └─→ 玩家操作流程：
            │
            ├─→ Step 1：点击要进化的基础卡（手中展示区）
            │   └─→ 该卡高亮显示
            │
            ├─→ Step 2：点击进化目标卡（场上或预购区）
            │   └─→ 该卡高亮显示
            │
            ├─→ Step 3：系统自动验证进化条件
            │   ├─→ 是否为正确的进化链和进化目标？（1→2 或 2→3）
            │   ├─→ 抵扣球是否足够？
            │   │
            │   └─→ ✅ 全部满足：
            │       └─→ "进化"按钮亮起
            │
            └─→ Step 4：玩家选择
                │
                ├─→ 点击进化选项（选择要进化的卡牌）：
                │   ├─→ 基础卡从展示区移除 → 丢弃
                │   ├─→ 进化卡加入展示区
                │   ├─→ 如果是场上卡：补充新卡到场上
                │   ├─→ 如果是预购区：从预购区移除
                │   ├─→ 更新玩家分数
                │   └─→ 进化完成 → 自动结束回合
                │
                └─→ 点击"跳过进化"按钮：
                    └─→ 自动结束回合（不进化）
```

**进化规则要点：**
- 每回合最多进化：1次
- 进化链：1级→2级→3级（4级/5级不能进化）
- 进化成本：抵扣球（不消耗手中球）
- 进化来源：场上卡牌 或 预购区卡牌
- 自动检查：动作完成后自动检查，无需手动触发

**进化示例：**
```
玩家展示区有：妙蛙种子（Lv1）
玩家抵扣：绿球×3
场上有：妙蛙草（Lv2）
进化要求：妙蛙种子→妙蛙草，绿，3

检查结果：
✅ 是1级卡
✅ 找到进化目标（场上妙蛙草）
✅ 抵扣绿球3个 ≥ 需要3个
→ 可以进化！
```

---

## 🏆 分数检查与游戏结束

```
进化阶段结束
    ↓
【分数实时更新】
├─→ 买卡时：立即 +卡牌胜利点数
└─→ 进化时：立即 +进化卡点数 -基础卡点数
    ↓
【优先检查是否最后一轮】
is_last_turn == True？
    │
    ├─→ ✅ 是（已经是最后一轮）：
    │   └─→ 跳过分数检查，直接检查游戏是否结束
    │       │
    │       ├─→ 当前玩家 == 玩家4？
    │       │   └─→ ✅ 是：游戏结束 → 统计排名
    │       │
    │       └─→ ❌ 否：下一个玩家回合
    │
    └─→ ❌ 否（未被标记）：
        └─→ 检查当前玩家分数 ≥ 18分？
            │
            ├─→ ❌ 否（< 18分）：
            │   └─→ 下一个玩家回合
            │
            └─→ ✅ 是（≥ 18分，首次触发）：
                │
                ├─→ 检查：当前玩家是否为玩家4？
                │   │
                │   ├─→ ✅ 是玩家4：
                │   │   ├─→ 广播消息："玩家4达到18分，游戏结束！"
                │   │   └─→ 游戏直接结束 → 统计排名
                │   │
                │   └─→ ❌ 不是玩家4（玩家1/2/3）：
                │       ├─→ 设置 is_last_turn = True
                │       ├─→ 广播消息："游戏进入最后一轮！"
                │       ├─→ 记录触发玩家
                │       └─→ 下一个玩家回合

【游戏结束 - 排名统计】
    │
    ├─→ Step 1: 收集所有玩家数据
    │   └─→ 玩家序号、名字、最终分数
    │
    ├─→ Step 2: 排序规则
    │   ├─→ 主要：按分数降序（分高在前）
    │   └─→ 次要：同分时，玩家序号大的在前
    │       （后手玩家排名更高）
    │
    └─→ Step 3: 显示最终排名
        └─→ 例如：
            🥇 第1名：玩家3，19分
            🥈 第2名：玩家2，19分（同分，但是是先手）
            🥉 第3名：玩家1，17分
            4️⃣ 第4名：玩家4，16分
```

**排名示例：**
```
场景1 - 不同分数：
玩家1: 20分 → 第1名
玩家2: 18分 → 第2名
玩家3: 17分 → 第3名
玩家4: 15分 → 第4名

场景2 - 同分后手优先：
玩家1: 19分 → 第2名（同分，先手）
玩家2: 19分 → 第1名（同分，后手）
玩家3: 18分 → 第3名
玩家4: 16分 → 第4名

场景3 - 多人同分：
玩家1: 20分 → 第4名（同分，最先手）
玩家2: 20分 → 第3名（同分）
玩家3: 20分 → 第2名（同分）
玩家4: 20分 → 第1名（同分，最后手）
```

---

## 🎯 关键规则总结表

| 规则项 | 详细说明 | 备注 |
|--------|----------|------|
| **回合结构** | 1个动作 → 检查进化（最多1次）→ 检查分数 | 强制顺序，不可跳过 |
| **动作类型** | 拿球 / 买卡 / 预购（三选一） | 必须执行一个 |
| **拿球规则** | • 同色2个（需≥4个）<br>• 不同色最多3个 | 根据球池情况决定 |
| **持球上限** | 10个（含大师球） | 超过需放回 |
| **买卡条件** | 实际消耗 ≤ 手中球 + 大师球 | 抵扣球可减少成本 |
| **买卡支付** | 弹出界面，手动调整支付方案 | 大师球可替代任意颜色 |
| **预购限制** | 最多3张 | 每次预购 +1大师球 |
| **预购对象** | 场上Lv1/2/3卡 或 牌堆顶（盲预购） | Lv4/5稀有传说不可预购 |
| **进化条件** | ①有进化目标<br>②抵扣球足够 | 不消耗手中球 |
| **进化来源** | 场上卡池 或 预购区 | 1→2, 2→3 |
| **每回合进化** | 最多1次 | 可选择不进化 |
| **分数更新** | 买卡/进化时实时更新 | 立即生效 |
| **胜利触发** | ≥18分 → 标记最后一轮 | 首次触发 |
| **游戏结束** | 最后一轮 && 玩家4结束 | 统计排名 |
| **排名规则** | 分数高 → 同分后手高 | 玩家序号大优先 |

---

## ⚠️ 重要注意事项

### 1. 动作的强制性与自动流转
- **必须执行一个动作**（拿球/买卡/预购）
- **无需手动结束回合**：动作完成后自动进入进化阶段
- **自动流程**：动作 → 进化检查 → 自动结束回合 → 下一玩家

### 2. 进化的独立性
- 进化**不是**一个动作，是动作后的独立阶段
- 进化阶段可以选择不进化（跳过）
- 进化使用的是**抵扣球**，不消耗手中的球

### 3. 分数检查时机与顺序
- 买卡后立即更新分数
- 进化后立即更新分数
- **重要**：进化阶段结束后，先检查`is_last_turn`
  - 如果已是最后一轮：跳过分数检查
  - 如果不是最后一轮：才检查分数≥18分

### 4. 最后一轮机制与玩家4特殊规则
- **玩家1/2/3触发≥18分**：
  - 设置`is_last_turn = True`
  - 游戏进入最后一轮
  - 继续到玩家4结束后才真正结束
- **玩家4触发≥18分**：
  - 游戏直接结束（不需要再轮一圈）
  - 立即统计排名
- 触发后，设置`is_last_turn = True`
- 已标记最后一轮的后续玩家不再检查分数

### 5. 大师球的特殊性
- 预购获得：+1大师球
- 购买使用：可替代任意颜色
- 进化不用：只用抵扣球
- 可放回：球数超限时可以放回大师球

---

## 📝 流程图使用说明

本文档详细描述了游戏的完整逻辑流程，可用于：
1. **开发参考**：实现游戏逻辑时的权威文档
2. **测试验证**：测试游戏时对照检查
3. **规则说明**：向玩家解释游戏规则
4. **Bug修复**：当游戏行为异常时的对照标准

建议在实现代码前，先与产品/策划确认此流程图是否准确反映了游戏设计意图。

---

**文档版本：** v1.0  
**最后更新：** 2025-10-14  
**维护者：** 开发团队


